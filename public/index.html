<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <title>化学仪器预约</title>
        <link rel="stylesheet" type="text/css" href="//chemorder.avosapps.com/sources/dhtmlxscheduler.css" media="screen" title="no title">
        <script type="text/javascript" src="//chemorder.avosapps.com/sources/dhtmlxscheduler.js"></script>
        <script type="text/javascript" src="//chemorder.avosapps.com/sources/ext/dhtmlxscheduler_agenda_view.js" ></script>
        <script type="text/javascript" src="//chemorder.avosapps.com/sources/ext/dhtmlxscheduler_units.js"></script>
        <script type="text/javascript" src="//chemorder.avosapps.com/sources/locale/locale_cn.js"></script>
        <script src="https://cn.avoscloud.com/scripts/lib/av-0.2.7.min.js"></script>
        <style type="text/css" media="screen">
            html, body{
                margin:0;
                padding:0;
                height:100%;
                overflow:hidden;
            }
            #login_form {
                padding: 20px;
                font: normal bold 20px '宋体','Arial','sans-serif';
            }
            #login_form label{
                display:block;
                float: left;
                width:80px;
                padding: 2px 0;
                line-height: 24px;
                text-align: right;
            }
            #login_form input[type=text],input[type=password] {
                display: block;
                width: 160px;
                float: left;
                line-height: 24px;
                padding: 0;
            }
            #login_form input[type=submit],input[type=reset] {
                width: 60px;
                height: 30px;
                font-size: 24px;
                float: left;
                display: block;
                padding: 6px 8px;
                margin-left: 60px;
                margin-top: 1em;
            }
            .dhx_cal_event.instrument_1 div{
                background-color: #12be00 !important;
            }
            .dhx_cal_event.instrument_2 div{
                background-color: #2babf5 !important;
            }
            .dhx_cal_event.instrument_3 div{
                background-color: #FFB951 !important;
            }
            .dhx_cal_event.instrument_4 div{
                background-color: #FF5353 !important;
            }
            .dhx_cal_event.instrument_5 div{
                background-color: #e0ffff !important;
            }
            .dhx_cal_event.instrument_6 div{
                background-color: #6a36a5 !important;
            }
            /*event in day or week view*/
            .dhx_cal_event.past_event div{
                background-color: #ECECEC !important;
                color: white !important;
            }
            /*multi-day event in month view*/
            .dhx_cal_event_line.past_event{
                background-color: black !important;
                color: white !important;
            }
            /*event with fixed time, in month view*/
            .dhx_cal_event_clear.past_event{
                color: lightgray !important;
            }

            .dhx_cal_event.event_math div, .dhx_cal_event_line.event_math{
                background-color: orange !important;
                color: blue !important;
            }
            .dhx_cal_event_clear.event_math{
                color: blue !important;
            }

            .dhx_cal_event.event_science div, .dhx_cal_event_line.event_science{
                background-color: #add8e6 !important;
                color: #8b0000 !important;
            }
            .dhx_cal_event_clear.event_science{
                color: #8b0000 !important;
            }

            .dhx_cal_event.event_english div, .dhx_cal_event_line.event_english{
                background-color: #e0ffff !important;
                color: #008b8b !important;
            }
            .dhx_cal_event_clear.event_english{
                color: #008b8b !important;
            }

        </style>

        <script type="text/javascript">
            var instruments = [
                {key: '1', label: '仪器1'},
                {key: '2', label: '仪器2'},
                {key: '3', label: '仪器3'},
                {key: '4', label: '仪器4'}
            ];

            AV.initialize("avodj4g7s3agqk70yagr06c7bcpjeh3afuorowptvlx78rui", "xekhpzxntxakkq59iwxqzyie0lz9s217h64y28payas6jd8x");
            AV.useAVCloudCN();

            function getInstrumentName(key) {
                instruments.forEach(function(o, i) {
                    if (o.key === key)
                        return o.label;
                });
                return "";
            }
            function checkLogin() {
                if (AV.User.current())
                    return true;
                else {
                    showLogin();
                    return false;
                }
            }
            function checkEventOwner(data) {
                if (checkLogin()) {
                    if (typeof data !== "object")
                        data = scheduler.getEvent(data);
                    if (!data)
                        return false;
                    if (data.owner.objectId === AV.User.current().id)
                        return true;
                    else {
                        dhtmlx.message("不是你的不要改啦...");
                        return false;
                    }
                }
            }
            function saveEvent(id, data) {
                data.owner = AV.User.current();
                data.text = AV.User.current().getUsername() + "预订了" + getInstrumentName(data.instrument) + ",TA说：" + data.text;
                var event = new AV.Object("Event");
                event.save(data, {
                    success: function(event) {
                        dhtmlx.message("保存成功！");
                        scheduler.editStop(id);
                        scheduler.unselect(id);
                    },
                    error: function(event, error) {
                        dhtmlx.message("保存失败！");
                    }
                });
            }
            function updateEvent(data) {
                var query = new AV.Query(AV.Object.extend("Event"));
                query.get(data.id, {
                    success: function(event) {
                        event.save(data, {
                            success: function(event) {
                                dhtmlx.message("保存成功！");
                                scheduler.updateEvent(data.id);
                            },
                            error: function(event, error) {
                                dhtmlx.message("保存失败！");
                            }
                        });
                    },
                    error: function(event, error) {
                        dhtmlx.message("更新失败！");
                    }
                });
            }

            function deleteEvent(id) {
                if (checkEventOwner(id)) {
                    AV.Object.createWithoutData("Event", id).destroy({
                        success: function() {
                            dhtmlx.message("已删除！");
                        },
                        error: function() {
                            dhtmlx.message("删除失败！");
                        }
                    });
                }
            }

            function showlogin() {
                var form = document.createElement("form");
                form.id = "login_form";
                form.action = "#";
                form.innerHTML = '<label>用户名：</label><input type="text" name="username" placeholder="学号" /><br /><label>密码：</label><input type="password" placeholder="懂的人懂..." name="password"/><br /><input type="submit" value="登录"/><input type="reset" value="取消"/>';
                form.onsubmit = function(e) {
                    e = e || window.event;
                    e.stopPropagation();
                    var u = this["username"].value;
                    var p = this["password"].value;
                    AV.User.logIn(u, p, {
                        success: function() {

                        },
                        error: function() {
                            if (u + "_bnpc" === p)
                                AV.User.signUp(u, p, {}, {
                                    success: function(user) {
                                        alert(user);
                                    },
                                    error: function(user, error) {
                                        alert(error);
                                    }
                                });
                        }
                    });
                    return false;
                };
                form.onreset = function() {
                    //box.remove();
                    scheduler.hideCover(box);
                    return false;
                };
                var box = dhtmlx.modalbox({
                    id: "login_box",
                    title: "请先登录",
                    content: form
                });
            }
            ;

            function init() {
                scheduler.config.xml_date = "%Y-%m-%d %H:%i";
                scheduler.config.time_step = 30;
                scheduler.config.multi_day = true;
                scheduler.config.first_hour = 8;
                scheduler.config.last_hour = 22.5;
                scheduler.config.event_duration = 120;
                scheduler.config.show_loading = true;
                scheduler.config.auto_end_date = true;
                scheduler.config.full_day = true;
                scheduler.config.mark_now = true;
                scheduler.config.drag_create = true;

                scheduler.config.details_on_create = false;
                scheduler.config.agenda_start = new Date();
                scheduler.locale.labels.section_instrument = "仪器";
                scheduler.locale.labels.agenda_tab = "预约记录";
                scheduler.locale.labels.unit_tab = "仪器";

                scheduler.templates.event_class = function(start, end, event) {
                    if (end < new Date()) // event start before control date
                        return "past_event";
                    if (event.instrument) // if event has subject property then special class should be assigned
                        return "instrument_" + event.instrument;

                    return ""; // default return

                    /*
                     Note that it is possible to create more complex checks
                     events with the same properties could have different CSS classes depending on the current view:
                     
                     var mode = scheduler.getState().mode;
                     if(mode == "day"){
                     // custom logic here
                     }
                     else {
                     // custom logic here
                     }
                     */
                };

                scheduler.serverList("instruments", instruments);

                scheduler.config.lightbox.sections = [
                    {name: "description", height: 43, map_to: "text", type: "textarea", focus: true, default_value: "说明"},
                    {name: "instrument", height: 20, type: "select", options: scheduler.serverList("instruments"), map_to: "instrument"},
                    {name: "time", height: 72, type: "time", map_to: "auto", time_format: ["%Y", "%m", "%d", "%H:%i"]}
                ];
                scheduler.createUnitsView({
                    name: "unit",
                    property: "instrument",
                    list: scheduler.serverList("instruments"),
                    size: 20,
                    step: 1
                });
                scheduler.attachEvent("onEventSave", function(id, data, flag) {
                    saveEvent(id, data);
                    return true;
                });

                scheduler.attachEvent("onBeforeEventChanged", function(ev, e, flag, ev_old) {
                    if (flag) {
                        scheduler.unselect(ev.id);
                        scheduler.showLightbox(ev.id);
                        return true;
                    }
                    else {
                        updateEvent(ev);
                    }
                    return true;
                });

                scheduler.attachEvent("onBeforeEventDelete", function(id, e) {
                    return checkEventOwner(id);
                });
                scheduler.attachEvent("onEventDeleted", function(id) {
                    deleteEvent(id);
                });
                scheduler.attachEvent("onEventCollision", function(ev, collisions) {

                });
                scheduler.attachEvent("onBeforeDrag", function(id, mode, e) {
                    if (checkLogin()) {
                        if (mode === 'create')
                            return true;
                        else {
                            return checkEventOwner();
                        }
                    }
                });

                var today = new Date();
                scheduler.init('orders', today, "week");

                var start = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
                var query = new AV.Query("Event");
                query.greaterThan("start_date", start).find({
                    success: function(events) {
                        var data = [];
                        events.forEach(function(o, i) {
                            var d = o.toJSON();
                            d.id = d.objectId;
                            d.start_date = new Date(d.start_date.iso);
                            d.end_date = new Date(d.end_date.iso);
                            data.push(d);
                        });
                        scheduler.parse(data, 'json');
                    },
                    error: function(error) {
                        dhtmlx.message("加载失败！请刷新网页");
                    }
                });

            }
        </script>
    </head>
    <body onload="init();">
        <div id="orders" class="dhx_cal_container" style='width:100%; height:100%;'>
            <div class="dhx_cal_navline">
                <div class="dhx_cal_prev_button">&nbsp;</div>
                <div class="dhx_cal_next_button">&nbsp;</div>
                <div class="dhx_cal_today_button"></div>
                <div class="dhx_cal_date"></div>
                <div class="dhx_cal_tab" name="day_tab" style="right:204px;"></div>
                <div class="dhx_cal_tab" name="week_tab" style="right:204px;"></div>
                <div class="dhx_cal_tab" name="month_tab" style="right:204px;"></div>
                <div class="dhx_cal_tab" name="agenda_tab" style="right:280px;"></div>
                <div class="dhx_cal_tab" name="unit_tab" style="right:280px;"></div>
            </div>
            <div class="dhx_cal_header">
            </div>
            <div class="dhx_cal_data">
            </div>      
        </div>
        <div id="login" style="display:none;">
            <form id="login_form">
                <label for="username">用户名：<input id="username" type="text" name="username" placeholder="学号"/></label>
                <label for="password">密码：<input id="password" type="password" name="password" placeholder="懂的人懂"/></label>
            </form>
        </div>
    </body>
